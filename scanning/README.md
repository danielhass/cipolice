# Image Scanner

Wraps around `docker pull` and scans an image with Clair. Will print the image
tag and the highest CVE severity level found in the image.

## Prerequisites

- Install Docker and docker-compose
- Install Klar, erlang and RabbitMQ server with `scanner_setup.sh`
- `pip install -r requirements.txt`

## Setup

Run clair:
```
cd clair-test
sudo docker-compose up -d
```
Keep in mind that clair takes a while to populate the CVE database the first time,
and during that time it will return no vulnerabilities. This takes 20-30 minutes.

## Deploying on Openshift (Experimental)

Use the "oc" branch of this repository to deploy the scanner to Openshift. Please keep in mind this deployment is experimental. The branch has a modified README with the setup instructions to recreate the deployment.

## Usage

The program has 3 modes, 'experiment', 'detail' and 'pull'.

### Pull/push mode

Pull mode will pull the image to the local registry and scan it with clair.
It will print the 'message' that will be sent to the policy engine.

Push mode can be used for a custom image.

Example:
```
$ python3 scan.py pull nginx:latest

...

Image: nginx:latest, Result: 3
```
The severity levels for clair are:
- None (0)
- Unknown (1)
- Negligible (2)
- Low (3)
- Medium (4)
- High (5)
- Critical (6)
- Defcon1 (7)

Refer to clair's documentation for a detailed explanation of the severity levels.
The program will return 'None' if no vlunerabilities are found by clair.

This option will submit the result to the rule engine via RabbitMQ.

### Detail mode

If the detailed output from Clair is desired, run the above example as follows:

```
$ python3 scan.py detail nginx:latest
```

This option will generate a report of all CVEs at both stdout and a file called
`output.json`

The user will then have the option to manually whitelist the image, overwriting an
automated blacklist policy generated by the rule engine.

### Cluster mode

Cluster mode will attempt to detect all images deployed to the current Openshift namespace (requires that the user is logged into the CLI) and then scan all of them.

```
$ python3 scan.py cluster
```

### Experiment mode

Experiment mode will scan all images of the official `library` registry to
obtain an overview of the security status of official images.

Be aware that this
mode will use a large amount of storage and despite cleaning up, some data will
remain. As of mid April 2020 it can consume ~80 GB and only clean up ~30 GB.

 Here are some sample results, limited to 'Low' vulnerabilities or higher.

- Total images: 160
- Images scanned successfully: 148
- At least one Low: 108 (73%)
- At least one Medium: 39 (26%)
- At least one High: 6 (4%)
